putinbank(extra_code_bank.ramcheck.01)
const unsigned char nt_ramcheck[]={
0x03,0x00,0x03,0x6b,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x8b,0x00,0x03,0x16,0x93,
0x94,0x95,0x96,0x97,0x98,0x99,0x9a,0x9b,0x9c,0x00,0x03,0x14,0xa2,0xa3,0x02,0x02,
0xa6,0xa7,0xa8,0xa9,0x02,0x02,0xac,0xad,0x00,0x03,0x09,0x80,0x81,0xb0,0x03,0x06,
0xb1,0xb2,0x02,0x03,0x02,0xb6,0xb7,0xb8,0xb9,0x02,0x03,0x02,0xbd,0xbe,0xbf,0x03,
0x06,0x8e,0x8f,0x90,0x91,0x92,0xb3,0xb3,0xb4,0xb3,0xb4,0xb3,0xb4,0xb5,0x03,0x02,
0xbb,0xc6,0xc7,0xc8,0xc9,0xb4,0xb5,0x03,0x02,0xbb,0xbc,0xbb,0xbc,0xbb,0xbc,0xbc,
0x9d,0x9e,0x9f,0xa0,0xa1,0x82,0x83,0xa4,0xa5,0xa4,0xa5,0xa4,0xa5,0xd4,0xd5,0xd6,
0xaa,0xab,0xaa,0xa5,0xa4,0xa5,0xd6,0xda,0xd4,0xaa,0xab,0xaa,0xab,0xaa,0xab,0x8c,
0x8d,0xae,0xaf,0xc0,0xc1,0xc2,0x01,0x03,0x09,0x53,0x6f,0x72,0x72,0x79,0x21,0x01,
0x03,0x09,0xcd,0xce,0xcf,0xd0,0xd1,0xd2,0x01,0x03,0x19,0xed,0xee,0xef,0xe0,0xe1,
0xe2,0x54,0x68,0x69,0x73,0x01,0x65,0x6d,0x75,0x6c,0x61,0x74,0x6f,0x72,0x01,0x64,
0x6f,0x65,0x73,0x6e,0x27,0x74,0x01,0x68,0x61,0x76,0x65,0xdd,0xde,0xdf,0xd0,0xd1,
0xd2,0x66,0x65,0x61,0x74,0x75,0x72,0x65,0x73,0x01,0x74,0x68,0x61,0x74,0x01,0x74,
0x68,0x69,0x73,0x01,0x67,0x61,0x6d,0x65,0x01,0x03,0x02,0xdd,0xde,0xdf,0xe0,0xe1,
0xe2,0x72,0x65,0x71,0x75,0x69,0x72,0x65,0x73,0x01,0x74,0x6f,0x01,0x72,0x75,0x6e,
0x01,0x70,0x72,0x6f,0x70,0x65,0x72,0x6c,0x79,0x2e,0x01,0xed,0xee,0xef,0xd0,0xd1,
0xd2,0x01,0x03,0x19,0xdd,0xde,0xdf,0xe0,0xe1,0xe2,0x01,0x20,0x03,0x03,0x01,0x4d,
0x45,0x4d,0x01,0x70,0x72,0x65,0x73,0x65,0x6e,0x74,0x3a,0x01,0x20,0x03,0x02,0x01,
0x4b,0x42,0x01,0xed,0xee,0xef,0xd0,0xd1,0xd2,0x01,0x20,0x03,0x03,0x01,0x4d,0x45,
0x4d,0x01,0x72,0x65,0x71,0x75,0x69,0x72,0x65,0x64,0x3a,0x20,0x03,0x02,0x01,0x4b,
0x42,0x01,0xdd,0xde,0xdf,0xe0,0xe1,0xe2,0x01,0x03,0x19,0xed,0xee,0xef,0xd0,0xd1,
0xd2,0x01,0x03,0x19,0xdd,0xde,0xdf,0xd0,0xd1,0xd2,0x01,0x01,0x49,0x66,0x01,0x75,
0x73,0x69,0x6e,0x67,0x01,0x61,0x6e,0x01,0x65,0x6d,0x75,0x6c,0x61,0x74,0x6f,0x72,
0x3a,0x01,0x03,0x02,0xed,0xee,0xef,0xe0,0xe1,0xe2,0x01,0x03,0x03,0x50,0x4c,0x45,
0x41,0x53,0x45,0x01,0x55,0x53,0x45,0x01,0x4d,0x45,0x53,0x45,0x4e,0x32,0x2e,0x01,
0x03,0x03,0xdd,0xde,0xdf,0xd0,0xf1,0xf2,0xe4,0xe5,0xe6,0xe7,0xe4,0xe5,0xe6,0xe5,
0xe6,0xe7,0xe4,0xe5,0xe6,0xe9,0xe5,0xeb,0xe7,0xe9,0xe5,0xe9,0xe5,0xeb,0xe7,0xe9,
0xe5,0xeb,0xfd,0xfe,0xdf,0xf0,0x02,0x03,0x05,0xc3,0xc4,0xc5,0x03,0x0d,0xcb,0xcc,
0x02,0x03,0x05,0xff,0xf0,0x02,0x03,0x05,0xd3,0x02,0x03,0x06,0x6f,0x6b,0x02,0x03,
0x06,0xdc,0x02,0x03,0x05,0xff,0xf3,0x02,0x03,0x05,0xe3,0xd7,0xd9,0x03,0x0e,0xec,
0x02,0x03,0x05,0xfc,0xf4,0xf5,0xf6,0xf7,0x03,0x04,0xf8,0x03,0x0f,0xf7,0x03,0x04,
0xf9,0xfa,0xfb,0x00,0x03,0x8f,0x44,0x55,0x03,0x05,0x11,0x44,0x55,0x03,0x05,0x11,
0x44,0x55,0x03,0x05,0x11,0x04,0x05,0x03,0x05,0x01,0x00,0x03,0x0f,0x03,0x00
};

putinbank(extra_code_bank.ramcheck.02)
const char str_ramtype[][8] = {
    "VIDEO",
    "N.T.",
    "SAVE"
};

putinbank(extra_code_bank.ramcheck.03)
const char str_ramcount[][4] = {
    "  1",
    "  2",
    "  4",
    "  8",
    " 16",
    " 32",
    " 64",
    "128",
};

putinbank(extra_code_bank.ramcheck.06)
unsigned char check_vram_amount(){
    unsigned char bank = 0;

    // write the value
    vram_adr(0);
    set_chr_mode_2(0);
    PPU.vram.data = 0x55;

    do {
        set_chr_mode_2((1 << bank));

        vram_adr(0x1000);
        PPU.vram.data; // prime read
        if(PPU.vram.data == 0x55) break;

        bank++;
    } while (bank != 5);
    return bank;
}


putinbank(extra_code_bank.ramcheck.09)
void state_ramcheck(){
    unsigned char type,ramcount,ramneeded;

    oam_clear();

    type = 0;
    ramcount = check_vram_amount();
    ramneeded = 5;
    // first, test chr-ram.
    if (ramcount != ramneeded) {
        __attribute__((leaf)) __asm__ volatile(
            "jmp ramcheck_failed"
        );
    }

    //type = 1;
    // test nametable ram here

    //type = 2;
    // test save ram here



    __attribute__((leaf)) __asm__ volatile(
        "rts \n"
        "ramcheck_failed: \n"
    );
    set_chr_default();

    pal_bg(pal_logo);

    vram_adr(0x2000);
    vram_unrle(nt_ramcheck);

    str_vram_buffer(str_ramtype[type], NT_ADR_A(4,15));
    str_vram_buffer(str_ramtype[type], NT_ADR_A(4,16));

    str_vram_buffer(str_ramcount[ramcount], NT_ADR_A(22,15));
    str_vram_buffer(str_ramcount[ramneeded], NT_ADR_A(22,16));

    vram_adr(0);
    donut_decompress_vram(chr_menu_global, chr_bank_0);
    donut_decompress_vram(chr_menu_font_pvz_filled, chr_bank_0);
    donut_decompress_vram(chr_menu_window, chr_bank_0);

    automatic_fs_updates = 1;
    music_play(song_adventure_start);

    ppu_on_all();
    pal_bright(4);
    while(1){
        ppu_wait_nmi();

    }
}
