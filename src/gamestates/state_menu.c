putinbank(extra_code_bank.menu.00)
const unsigned char pal_title[32]={ 
    0x0f,0x00,0x28,0x38,
    0x0f,0x00,0x10,0x30,
    0x0f,0x0b,0x29,0x1b,
    0x0f,0x07,0x10,0x00,
    
    0x11,0x0f,0x10,0x30,
    0x11,0x0f,0x2a,0x28,
    0x11,0x28,0x17,0x0f,
    0x11,0x0f,0x21,0x31,
};

putinbank(extra_code_bank.menu.01)
const unsigned char nt_title[]={
0x01,0x00,0x01,0x83,0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x8b,
0x8c,0x8d,0x8e,0x8f,0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x00,0x01,0x08,0x97,0x98,
0x99,0x9a,0x9b,0x9c,0x9d,0x9e,0x9f,0xa0,0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,
0xa9,0xaa,0xab,0xac,0xad,0x00,0x01,0x08,0xae,0xaf,0xb0,0xb1,0xb2,0xb3,0xb4,0xb5,
0xb6,0xb7,0xb8,0xb9,0xba,0xbb,0xbc,0xbd,0xbe,0xbf,0xc0,0xc1,0xc2,0xc3,0xc4,0x00,
0x01,0x08,0xc5,0xc6,0xc7,0xc8,0xc9,0xca,0xcb,0xcc,0xcd,0xce,0xcf,0xd0,0xd1,0xd2,
0xd3,0xd4,0xd5,0xd6,0xd7,0xd8,0xd9,0xda,0xdb,0xdc,0x00,0x01,0x0e,0x44,0x65,0x70,
0x6c,0x61,0x6e,0x74,0x65,0x64,0x00,0x01,0x10,0x57,0x61,0x6c,0x6c,0x2d,0x6e,0x75,
0x74,0x00,0x42,0x6f,0x77,0x6c,0x69,0x6e,0x67,0x00,0x44,0x65,0x6d,0x6f,0x00,0x01,
0x8e,0x41,0x64,0x76,0x65,0x6e,0x74,0x75,0x72,0x65,0x00,0x31,0x2d,0x35,0x00,0x01,
0xfe,0x00,0x01,0xf2,0xaa,0x01,0x02,0xee,0xff,0x01,0x03,0x00,0x01,0x07,0x55,0x01,
0x1f,0x05,0x01,0x07,0x01,0x00
};

putinbank(extra_code_bank.menu.02)
const uint8_t mspr_title[]={
    // everything in this table is shifted to the left by
    // one pixel due to *the problematic line.*

    // small button sprites
    87, 184, 0xf5, 1,
    95, 184, 0xf7, 1,
    119, 184, 0xf1, 1,
    127, 184, 0xf3, 1, // this line is problematic.
    151, 184, 0xf9, 1,
    159, 184, 0xfb, 1,

    // ROBTOP text
    7, 200, 0x41, 2,  // r/t
    15, 200, 0x43, 2, // o/f
    23, 200, 0x45, 2, // b/d
    31, 200, 0x47, 2, // t/s
    39, 200, 0x49, 2, // o/o
    47, 200, 0x4b, 2, // p/f
    55, 200, 0x4d, 2, //  /t

    // large button sprites (the blue parts)
    // (top)
    116, 101, 0xd7, 0b00100011,
    130, 101, 0xd7, 0b00100011,
    70, 102, 0xd7, 0b00100011,
    80, 102, 0xd7, 0b00100011,
    166, 102, 0xd7, 0b00100011,
    176, 102, 0xd7, 0b00100011,

    // (bottom)
    116, 108, 0xd7, 0b00100011,
    130, 108, 0xd7, 0b00100011,
    70, 106, 0xd7, 0b00100011,
    80, 106, 0xd7, 0b00100011,
    166, 106, 0xd7, 0b00100011,
    176, 106, 0xd7, 0b00100011,
 
    0x80 // end of data
};

putinbank(extra_code_bank.menu.03)
const uint8_t mspr_selectarrow[]={
    0, 0,  0x5f,   0b00000000,
    8,  0,  0x5f,   0b01000000,
    0x80
};

putinbank(extra_code_bank.menu.04)
const uint8_t mspr_selectbox[]={
    0, 0,  0x4f,   0b00000000,
    8,  0,  0x4f,   0b01000000,
    0x80
};

putinbank(extra_code_bank.menu.05)
const uint16_t mspr_select_pos[]={
    0x5078, // play
    0x50a8, // community
    0xb858, // settings
    0xb878, // music
    0xb898, // help
    0x5048, // icon kit
};
#define menu_button_count (sizeof(mspr_select_pos)>>1)

putinbank(extra_code_bank.menu.text)
const char str_demo[] = "Demo";

putinbank(extra_code_bank.menu.09)
void state_menu() {
    signed char selection = 0;

    automatic_fs_updates=1;

    disable_nmi();
    // load menu stuff
    vram_adr(0x000);
    donut_decompress_vram(chr_menu_global, chr_bank_0);
    donut_decompress_vram(chr_menu_font_pvz_transparent, chr_bank_0);
    donut_decompress_vram(chr_menu_pvzlogo, chr_bank_0);

    // write the title screen tilemap
    vram_adr(0x2000);
    vram_unrle(nt_title);

    enable_nmi();

    pal_all(pal_title);

    
    /*flush_irq();
    add_advanced_interrupt( // set button chr
        94, 
        irq_set_chr,
        args88(5,7)
    );
    add_advanced_interrupt( // ground scroll
        79, 
        irq_set_chr_and_scroll,
        args88(5,8)
    );
    add_advanced_interrupt( // set background chr
        47, 
        irq_set_chr_and_scroll,
        args88(3,0x10)
    );
    enable_irq();*/
    
    // run once before fading in
    //oam_clear();
    //oam_meta_spr(1,0,mspr_title);

    //str_vram_buffer(str_version, NT_ADR_A(20,9));

    #ifdef FLAG_ISDEMO
        str_vram_buffer(str_demo, NT_ADR_A(1,3));
        one_vram_buffer(FLAG_ISDEMO, NT_ADR_A(6,3));
    #endif

    /*flush_irq();
    add_advanced_interrupt(
        56,
        irq_set_chr,
        args88(3,8)
    );
    enable_irq();*/

    ppu_on_all();
    pal_fade_to(1,4);

    // for some reason, the compiler
    // absolutely REFUSES to put an
    // lda #0 before running this, so
    // do it manually here (if song is 0)
    __asm__("lda #0"); 
    music_play(song_crazy_dave);

    
    //interrupt_scroll = 0;
    while(1){
        ppu_wait_nmi();
        scroll(0,0);
        oam_clear();
        
        
        if((selection >= 2) && (selection < 5)){
            oam_meta_spr(
                low_byte(mspr_select_pos[selection]),
                high_byte(mspr_select_pos[selection]),
                mspr_selectbox
            );
        } else {
            oam_meta_spr(
                low_byte(mspr_select_pos[selection]),
                high_byte(mspr_select_pos[selection]),
                mspr_selectarrow
            );
        }

        // the fact that i can use a metasprite for
        // EVERYTHING on the menu is bloody brilliant
        oam_meta_spr(1,0,mspr_title); // one to the right
                                    // so i can put sprites at
                                    // x = 128
        
        if(player1_pressed & PAD_RIGHT) selection++;
        if(player1_pressed & PAD_LEFT) selection--;

        if(player1_pressed & PAD_DOWN) selection += (menu_button_count>>1);
        if(player1_pressed & PAD_UP) selection -= (menu_button_count>>1);

        if(selection >= ((uint8_t)menu_button_count)) {
            selection -= menu_button_count;
        }
        if(selection < 0) {
            selection += menu_button_count;
        }

        if(player1_pressed & PAD_B) {
            break;
        }

        if(player1_pressed & PAD_A) {
            switch(selection){
                default:
                    music_play(song_adventure_start);
                    for(short i=300; i>0; i--){
                        ppu_wait_nmi();
                    }
                    gamestate = 0x20;
                    break;
            }
            pal_bright(0);
            break;
        }
        //if(player1_pressed & PAD_SELECT) {
        //    gamestate = 0xf0;
        //    break;
        //}

    }
}



/*

putinbank(extra_code_bank.levelselect.00)
const unsigned char pal_levelselect[16]={ 0x11,0x01,0x11,0x30,0x11,0x0f,0x2a,0x39,0x11,0x0f,0x10,0x30,0x11,0x0f,0x21,0x31 };

putinbank(extra_code_bank.levelselect.01)
const unsigned char nt_levelselect[324]={
0x04,0x01,0x04,0x3f,0x00,0x04,0x05,0x1a,0x1b,0x0e,0x07,0x04,0x03,0x0f,0x0e,0x07,
0x07,0x0f,0x0e,0x07,0x04,0x03,0x0f,0x1a,0x1b,0x00,0x04,0x0d,0x1e,0x17,0x04,0x03,
0x1f,0x14,0x02,0x02,0x15,0x1e,0x17,0x04,0x03,0x1f,0x00,0x04,0x15,0x12,0x11,0x11,
0x13,0x00,0x04,0x73,0x9c,0x01,0x04,0x11,0x9e,0x00,0x04,0x0b,0x01,0x04,0x13,0x00,
0x04,0x0b,0x01,0x04,0x13,0x00,0x04,0x0b,0x01,0x04,0x13,0x00,0x04,0x0b,0x01,0x04,
0x13,0x00,0x04,0x0b,0x9d,0x01,0x04,0x11,0x9f,0x00,0x04,0x07,0xbc,0x00,0x04,0x19,
0xbe,0x00,0x04,0x03,0xbd,0x00,0x04,0x06,0x4e,0x4f,0x52,0x4d,0x41,0x4c,0x00,0x00,
0x4d,0x4f,0x44,0x45,0x00,0x04,0x06,0xbf,0x00,0x04,0x07,0x08,0x01,0x04,0x11,0x09,
0x00,0x04,0x2e,0x50,0x52,0x41,0x43,0x54,0x49,0x43,0x45,0x00,0x00,0x4d,0x4f,0x44,
0x45,0x00,0x04,0x0e,0x08,0x01,0x04,0x11,0x09,0x00,0x04,0x65,0x10,0x00,0x04,0x1d,
0x10,0x0e,0x0f,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,
0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0x0e,
0x0f,0x1e,0x1f,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,
0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0x1e,
0x1f,0x03,0x03,0x0e,0x0f,0x00,0x00,0xdc,0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,
0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,0xde,0xd0,0xd2,0x00,0x00,0x0e,0x0f,0x03,
0x03,0x02,0x02,0x1e,0x1f,0x10,0x00,0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,
0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,0xdf,0xd1,0xd3,0x00,0x10,0x1e,0x1f,0x02,
0x02,0x01,0x04,0x3f,0xff,0xff,0x5f,0xdf,0x7f,0x5f,0xff,0x04,0x09,0x00,0x04,0x07,
0xa0,0x50,0x04,0x05,0xa5,0xf5,0x04,0x0f,0x71,0x30,0x00,0x04,0x03,0xc0,0xd4,0x0f,
0x04,0x07,0x04,0x00
};

putinbank(extra_code_bank.levelselect.02)
const char str_levelselect[] = "stereo\x01madness";

putinbank(extra_code_bank.levelselect.09)
void state_levelselect(){
    scroll(0,0);
    automatic_fs_updates=1;

    vram_adr(0x000);
    donut_decompress_vram(chr_menu_global, chr_bank_0);
    donut_decompress_vram(chr_font, chr_bank_0);
    donut_decompress_vram(chr_menu_difficulties, chr_bank_0);
    donut_decompress_vram(chr_menu_buttons, chr_bank_0);
    
    vram_adr(0x2000);
    vram_unrle(nt_levelselect);

    pal_bg(pal_levelselect);

    set_chr_mode_5(8);

    str_vram_buffer(str_levelselect, NT_ADR_A(10,10));

    ppu_on_all();
    pal_fade_to(0,4);

    if(!famistudio_song_speed) {
        music_play(saved_menu_theme);
    }

    while(1){
        ppu_wait_nmi();
        oam_clear();

        if(player1_pressed & PAD_B) {
            gamestate = 0x10;
            pal_fade_to(4,0);
            break;
        }
        if(player1_pressed & PAD_A) {
            return_gamestate = gamestate;
            gamestate = 0x20;
            famistudio_music_stop();
            sfx_play(sfx_playsound_01,0);
            pal_fade_to(4,0);
            break;
        }
    }
}





putinbank(sound_test_bank.soundtest.00)
const unsigned char pal_genericmenu[16]={
    0x17,0x0f,0x10,0x30,
    0x17,0x0f,0x2a,0x39,
    0x17,0x11,0x21,0x30,
    0x17,0x0f,0x21,0x31 
};

putinbank(sound_test_bank.soundtest.01)
const unsigned char nt_genericmenu[351]={
0x04,0x01,0x04,0x46,0x06,0x01,0x04,0x0f,0x06,0x01,0x04,0x0a,0x19,0x04,0x02,0x05,
0x19,0x04,0x0f,0x05,0x19,0x04,0x02,0x01,0x04,0x06,0x09,0x0e,0x0f,0x0e,0x07,0x04,
0x11,0x0f,0x0e,0x0f,0x08,0x01,0x04,0x05,0x09,0x1e,0x1f,0x1e,0x17,0x04,0x06,0x74,
0x65,0x78,0x74,0x17,0x04,0x06,0x1f,0x1e,0x1f,0x08,0x01,0x04,0x06,0x0a,0x00,0x04,
0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,
0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,
0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,
0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,
0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,
0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,
0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,
0x15,0x0b,0x01,0x04,0x07,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x03,0x19,0x01,0x04,
0x02,0x0a,0x00,0x04,0x15,0x0b,0x01,0x04,0x02,0x19,0x10,0x1c,0x01,0x01,0x0a,0x00,
0x04,0x15,0x0b,0x01,0x01,0x1d,0x10,0x0e,0x0f,0x08,0x09,0x1a,0x1b,0x0e,0x07,0x04,
0x05,0x0f,0x0e,0x07,0x07,0x0f,0x0e,0x07,0x04,0x05,0x0f,0x1a,0x1b,0x08,0x09,0x0e,
0x0f,0x1e,0x1f,0x1c,0x19,0x18,0x0d,0x1e,0x17,0x04,0x05,0x1f,0x1e,0x17,0x17,0x1f,
0x1e,0x17,0x04,0x05,0x1f,0x0c,0x18,0x19,0x1d,0x1e,0x1f,0x03,0x03,0x0e,0x0f,0x1c,
0x01,0x18,0x04,0x13,0x01,0x1d,0x0e,0x0f,0x03,0x03,0x02,0x02,0x1e,0x1f,0x10,0x08,
0x01,0x04,0x13,0x09,0x10,0x1e,0x1f,0x02,0x02,0x01,0x04,0x3f,0xa0,0x04,0x07,0xaa,
0x17,0x05,0x04,0x03,0x4d,0xaa,0xaa,0x11,0x00,0x04,0x03,0x44,0xaa,0xaa,0x11,0x00,
0x04,0x03,0x44,0xaa,0xaa,0x11,0x00,0x04,0x03,0x44,0xaa,0xaa,0x11,0x00,0x04,0x03,
0x44,0xaa,0x79,0xa6,0xa5,0xad,0xa7,0xa5,0xa9,0xd6,0x00,0x04,0x07,0x04,0x00
};

putinbank(sound_test_bank.soundtest.02)
const char str_soundtest[] = "\x01sound\x01test\x01";

putinbank(sound_test_bank.soundtest.03)
const char str_music[] = "MUSIC"; 

putinbank(sound_test_bank.soundtest.04)
const char str_soundeffects[] = "SOUND EFFECTS";

putinbank(sound_test_bank.soundtest.05)
const char str_byartist[] = "BY:";

putinbank(sound_test_bank.soundtest.09)
void state_soundtest(){
    signed char selection = 0;
    unsigned char index[2] = {0,0};

    famistudio_music_stop();

    vram_adr(0x2000);
    vram_unrle(nt_genericmenu);

    pal_bg(pal_genericmenu);

    str_vram_buffer(str_soundtest, 0x20aa);
    str_vram_buffer(str_music, 0x2127);
    str_vram_buffer(str_byartist, 0x21c7);
    str_vram_buffer(str_soundeffects, 0x2227);

    ppu_on_all();
    pal_fade_to(0,4);

    while(1){
        ppu_wait_nmi();
        scroll(0,0);


        one_vram_buffer(0x00, (0x2126 + (selection << 8)));
        if(player1_pressed & PAD_DOWN){selection++;}
        if(player1_pressed & PAD_UP){selection--;}

        if(selection >= 2){selection = 0;}
        if(selection < 0){selection = 1;}
        one_vram_buffer('>', (0x2126 + (selection << 8)));


        if(player1_pressed & PAD_RIGHT){
            index[selection]++;
        }
        if(player1_pressed & PAD_LEFT){
            index[selection]--;
        }

        if(low_byte(index) == 0xff){index[0]++;}
        if(high_byte(index) == 0xff){index[1]++;}
        if(low_byte(index) == song_max){index[0]--;}
        if(high_byte(index) == sfx_max){index[1]--;}

        one_vram_buffer_repeat(' ', 17, (0x2168+(selection<<8)));
        if(selection == 0){
            one_vram_buffer_repeat(' ', 17, 0x2188);
            unsigned char tmp = high_byte(xbgmtextsUpper[low_byte(index)]);
            if(tmp){
                str_vram_buffer(
                    xbgmtextsUpper[low_byte(index)],
                    0x2168
                );
            }
            str_vram_buffer(
                xbgmtextsLower[low_byte(index)],
                0x2188
            );
            one_vram_buffer_repeat(' ', 14, 0x21cb);
            str_vram_buffer(
                xbgmtextsOriginalArtist[low_byte(index)],
                0x21cb
            );
        }
        if(selection == 1){
            str_vram_buffer(
                sfxtexts[high_byte(index)],
                0x2268
            );
        }

        one_vram_buffer(
            num_to_ascii(index[selection]),
            0x2138 + (selection << 8)
        );
        one_vram_buffer(
            num_to_ascii((index[selection]>>4)),
            0x2137 + (selection << 8)
        );



        if(player1_pressed & PAD_A) {
            switch(selection){
                case 0:
                    music_play(xbgmlookuptable[low_byte(index)]);
                    break;
                case 1:
                    sfx_play(high_byte(index),0);
                    break;
            }
        }
        if(player1_pressed & PAD_START) {
            famistudio_music_stop();
        }

        if(player1_pressed & PAD_SELECT) {
            if(!selection){
                sfx_play(sfx_counter003,0);
                saved_menu_theme = xbgmlookuptable[low_byte(index)];
            }
        }
        

        if(player1_pressed & PAD_B) {
            gamestate = 0x10;
            pal_fade_to(4,0);
            break;
        }
    }
    
}

*/




